"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getKVFilePath = exports.getContentFromKVAsset = void 0;
const getContentFromKVAsset = async (path, options) => {
    let ASSET_MANIFEST = {};
    if (options && options.manifest) {
        if (typeof options.manifest === 'string') {
            ASSET_MANIFEST = JSON.parse(options.manifest);
        }
        else {
            ASSET_MANIFEST = options.manifest;
        }
    }
    else {
        if (typeof __STATIC_CONTENT_MANIFEST === 'string') {
            ASSET_MANIFEST = JSON.parse(__STATIC_CONTENT_MANIFEST);
        }
        else {
            ASSET_MANIFEST = __STATIC_CONTENT_MANIFEST;
        }
    }
    let ASSET_NAMESPACE;
    if (options && options.namespace) {
        ASSET_NAMESPACE = options.namespace;
    }
    else {
        ASSET_NAMESPACE = __STATIC_CONTENT;
    }
    const key = ASSET_MANIFEST[path] || path;
    if (!key) {
        return null;
    }
    let content = await ASSET_NAMESPACE.get(key, { type: 'arrayBuffer' });
    if (content) {
        content = content;
    }
    return content;
};
exports.getContentFromKVAsset = getContentFromKVAsset;
const getKVFilePath = (options) => {
    let filename = options.filename;
    let root = options.root || '';
    const defaultDocument = options.defaultDocument || 'index.html';
    if (filename.endsWith('/')) {
        // /top/ => /top/index.html
        filename = filename.concat(defaultDocument);
    }
    else if (!filename.match(/\.[a-zA-Z0-9]+$/)) {
        // /top => /top/index.html
        filename = filename.concat('/' + defaultDocument);
    }
    // /foo.html => foo.html
    filename = filename.replace(/^\//, '');
    // assets/ => assets
    root = root.replace(/\/$/, '');
    // ./assets/foo.html => assets/foo.html
    let path = root ? root + '/' + filename : filename;
    path = path.replace(/^\.?\//, '');
    return path;
};
exports.getKVFilePath = getKVFilePath;
