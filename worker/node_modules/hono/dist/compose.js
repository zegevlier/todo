"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.compose = void 0;
const context_1 = require("./context");
// Based on the code in the MIT licensed `koa-compose` package.
const compose = (middleware, onError, onNotFound) => {
    return async (context, next) => {
        let index = -1;
        return dispatch(0);
        async function dispatch(i) {
            if (i <= index) {
                return Promise.reject(new Error('next() called multiple times'));
            }
            let handler = middleware[i];
            index = i;
            if (i === middleware.length && next)
                handler = next;
            if (!handler) {
                if (context instanceof context_1.Context && context.res._finalized === false && onNotFound) {
                    context.res = onNotFound(context);
                    context.res._finalized = true;
                }
                return Promise.resolve(context);
            }
            return Promise.resolve(handler(context, dispatch.bind(null, i + 1)))
                .then(async (res) => {
                // If handler return Response like `return c.text('foo')`
                if (res && context instanceof context_1.Context) {
                    context.res = res;
                    context.res._finalized = true;
                }
                return context;
            })
                .catch((err) => {
                if (context instanceof context_1.Context && onError) {
                    if (err instanceof Error) {
                        context.res = onError(err, context);
                        context.res._finalized = true;
                    }
                    return context;
                }
                else {
                    throw err;
                }
            });
        }
    };
};
exports.compose = compose;
